@page
@model ALAN.Web.Pages.ChatModel
@using System.Text.Json
@{
    ViewData["Title"] = "Chat with ALAN";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="display-4">Chat with ALAN</h1>
            <p class="lead">Interact with the LLM and its acquired knowledge</p>
        </div>
    </div>

    <div class="row">
        <!-- Chat with Agent Panel -->
        <div class="col-md-7 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üí¨ Chat with Agent</h5>
                    <small>Ask questions and interact with ALAN's knowledge</small>
                </div>
                <div class="card-body d-flex flex-column" style="height: 600px;">
                    <div id="chat-messages" class="flex-grow-1 mb-3 border rounded p-3" style="overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-muted text-center">
                            <p>Start a conversation with ALAN...</p>
                            <small>The agent will use its full context and acquired knowledge to respond.</small>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." />
                        <button class="btn btn-primary" type="button" id="send-chat-btn">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Steering Commands Panel -->
        <div class="col-md-5 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üéØ Steering Commands</h5>
                    <small>Direct the agent's behavior and goals</small>
                </div>
                <div class="card-body">
                    <!-- Update Prompt -->
                    <div class="mb-4">
                        <label for="prompt-input" class="form-label fw-bold">Update Agent Prompt</label>
                        <textarea id="prompt-input" class="form-control mb-2" rows="3" placeholder="Enter new directive for the agent..."></textarea>
                        <button class="btn btn-warning w-100" id="update-prompt-btn">Update Prompt</button>
                    </div>

                    <hr />

                    <!-- Agent Controls -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Agent Controls</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-secondary" id="pause-btn">‚è∏Ô∏è Pause Agent</button>
                            <button class="btn btn-success" id="resume-btn">‚ñ∂Ô∏è Resume Agent</button>
                            <button class="btn btn-info" id="batch-learning-btn">üìö Trigger Batch Learning</button>
                            <button class="btn btn-outline-primary" id="memory-consolidation-btn">üß† Consolidate Memory</button>
                        </div>
                    </div>

                    <hr />

                    <!-- Status Display -->
                    <div>
                        <label class="form-label fw-bold">Command Status</label>
                        <div id="command-status" class="alert alert-secondary small" role="alert">
                            Ready to send commands
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatApiBaseUrl = '@Model.ChatApiBaseUrl';
        let sessionId = localStorage.getItem('alanChatSessionId');
        if (!sessionId) {
            sessionId = crypto.randomUUID();
            localStorage.setItem('alanChatSessionId', sessionId);
        }

        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const commandStatus = document.getElementById('command-status');

        // Chat functionality
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${role === 'human' ? 'text-end' : ''}`;
            
            const badge = role === 'human' 
                ? '<span class="badge bg-primary">You</span>' 
                : '<span class="badge bg-success">ALAN</span>';
            
            const alignment = role === 'human' ? 'ms-auto' : '';
            const bgColor = role === 'human' ? 'bg-primary text-white' : 'bg-white border';
            
            messageDiv.innerHTML = `
                <div class="d-inline-block ${alignment}" style="max-width: 80%;">
                    ${badge}
                    <div class="${bgColor} rounded p-2 mt-1">
                        <small class="text-muted d-block mb-1">${new Date().toLocaleTimeString()}</small>
                        ${escapeHtml(content)}
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, 'human');
            chatInput.value = '';
            sendChatBtn.disabled = true;

            try {
                const response = await fetch(`${chatApiBaseUrl}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, sessionId: sessionId })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.messageId) {
                        sessionId = data.messageId;
                        localStorage.setItem('alanChatSessionId', sessionId);
                    }
                    addMessage(data.response ?? data, 'agent');
                } else {
                    addMessage('Sorry, I encountered an error processing your message.', 'agent');
                }
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('Sorry, I could not connect to the agent.', 'agent');
            } finally {
                sendChatBtn.disabled = false;
                chatInput.focus();
            }
        }

        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // Steering commands functionality
        function showCommandStatus(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';
            
            commandStatus.className = `alert ${alertClass} small`;
            commandStatus.textContent = message;
        }

        async function sendCommand(endpoint, data = {}) {
            try {
                showCommandStatus('Sending command...', 'info');
                const response = await fetch(`/api/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showCommandStatus(result.message || 'Command sent successfully', 'success');
                } else {
                    showCommandStatus('Failed to send command', 'error');
                }
            } catch (error) {
                console.error('Command error:', error);
                showCommandStatus('Error: Could not connect to agent', 'error');
            }
        }

        document.getElementById('update-prompt-btn').addEventListener('click', async () => {
            const prompt = document.getElementById('prompt-input').value.trim();
            if (!prompt) {
                showCommandStatus('Please enter a prompt', 'warning');
                return;
            }
            await sendCommand('prompt', { prompt: prompt });
            document.getElementById('prompt-input').value = '';
        });

        document.getElementById('pause-btn').addEventListener('click', () => sendCommand('pause'));
        document.getElementById('resume-btn').addEventListener('click', () => sendCommand('resume'));
        document.getElementById('batch-learning-btn').addEventListener('click', () => sendCommand('batch-learning'));
        document.getElementById('memory-consolidation-btn').addEventListener('click', () => sendCommand('memory-consolidation'));

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initial focus
        chatInput.focus();
    </script>
}
