@page
@model ALAN.Web.Pages.ChatModel
@using System.Text.Json
@{
    ViewData["Title"] = "Chat with ALAN";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="display-4">Chat with ALAN</h1>
            <p class="lead">Interact with the LLM via CopilotKit AG-UI interface</p>
        </div>
    </div>

    <div class="row">
        <!-- Chat with Agent Panel - Now using CopilotKit -->
        <div class="col-md-7 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üí¨ Chat with Agent (CopilotKit)</h5>
                    <small>Powered by CopilotKit with AG-UI protocol</small>
                </div>
                <div class="card-body d-flex flex-column" style="height: 600px;">
                    <!-- CopilotKit Chat Component will mount here -->
                    <div id="copilot-chat-root" data-chatapi-url="@Model.ChatApiBaseUrl"></div>
                </div>
            </div>
        </div>

        <!-- Steering Commands Panel -->
        <div class="col-md-5 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üéØ Steering Commands</h5>
                    <small>Direct the agent's behavior and goals</small>
                </div>
                <div class="card-body">
                    <!-- Update Prompt -->
                    <div class="mb-4">
                        <label for="prompt-input" class="form-label fw-bold">Update Agent Prompt</label>
                        <textarea id="prompt-input" class="form-control mb-2" rows="3" placeholder="Enter new directive for the agent..."></textarea>
                        <button class="btn btn-warning w-100" id="update-prompt-btn">Update Prompt</button>
                    </div>

                    <hr />

                    <!-- Agent Controls -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Agent Controls</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-secondary" id="pause-btn">‚è∏Ô∏è Pause Agent</button>
                            <button class="btn btn-success" id="resume-btn">‚ñ∂Ô∏è Resume Agent</button>
                            <button class="btn btn-info" id="batch-learning-btn">üìö Trigger Batch Learning</button>
                            <button class="btn btn-outline-primary" id="memory-consolidation-btn">üß† Consolidate Memory</button>
                        </div>
                    </div>

                    <hr />

                    <!-- Status Display -->
                    <div>
                        <label class="form-label fw-bold">Command Status</label>
                        <div id="command-status" class="alert alert-secondary small" role="alert">
                            Ready to send commands
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- CopilotKit Chat Component Bundle -->
    <script src="~/dist/copilot-chat.bundle.js"></script>
    
    <script>
        // Steering commands functionality
        function showCommandStatus(message, type = 'info') {
            const commandStatus = document.getElementById('command-status');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';
            
            commandStatus.className = `alert ${alertClass} small`;
            commandStatus.textContent = message;
        }

        async function sendCommand(endpoint, data = {}) {
            try {
                showCommandStatus('Sending command...', 'info');
                const response = await fetch(`/api/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showCommandStatus(result.message || 'Command sent successfully', 'success');
                } else {
                    showCommandStatus('Failed to send command', 'error');
                }
            } catch (error) {
                console.error('Command error:', error);
                showCommandStatus('Error: Could not connect to agent', 'error');
            }
        }

        document.getElementById('update-prompt-btn').addEventListener('click', async () => {
            const prompt = document.getElementById('prompt-input').value.trim();
            if (!prompt) {
                showCommandStatus('Please enter a prompt', 'warning');
                return;
            }
            await sendCommand('prompt', { prompt: prompt });
            document.getElementById('prompt-input').value = '';
        });

        document.getElementById('pause-btn').addEventListener('click', () => sendCommand('pause'));
        document.getElementById('resume-btn').addEventListener('click', () => sendCommand('resume'));
        document.getElementById('batch-learning-btn').addEventListener('click', () => sendCommand('batch-learning'));
        document.getElementById('memory-consolidation-btn').addEventListener('click', () => sendCommand('memory-consolidation'));
    </script>
}
